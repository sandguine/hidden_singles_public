---
title: "Recurrent Relational Network"
author: "Andrew"
date: "12/17/2020"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 4
    theme: cosmo
    highlight: tango
    pandoc_args: ["--number-offset=2"]
---

This file should be run after the 'Recurrent Relational Network.ipynb'.
```{r setup, include=FALSE}
# these options here change the formatting of how comments are rendered
knitr::opts_chunk$set(collapse = TRUE,
                      comment = "#>",
                      results = "hold",
                      fig.show = "hold")

# Clear any existing variables
rm(list = ls())
```

```{r libraries, message=FALSE}
library(glue)
library(tidyverse)

source("functions.R")
```

```{r}
# Set ggplot theme
theme_set(theme_light() +
            theme(plot.title = element_text(hjust = 0.5)))
```

# Sudoku 

## Load data

```{r, message=F}
df.sudoku = map_dfr(1:10,
                    ~ read_tsv(glue("../data/rrn/rrn_sudoku/rrn_sudoku_{.x}.tsv")) %>% 
                      mutate(run_id = .x)) %>% 
  pivot_longer(cols = c(loss, accuracy, solved),
               names_to = 'measure',
               values_to = 'value') %>% 
  mutate(measure = recode(measure,
                          loss = "Loss",
                          accuracy = "Cells Solved",
                          solved = "Puzzles Solved"),
         dataset = recode(dataset,
                          train = 'Train',
                          test = 'Valid'),
         dataset = factor(dataset,
                          levels = c('Train', 'Valid'))) %>% 
  select(run_id, everything())

df.sudoku %>% 
  filter(epoch == 100,
         dataset == 'Valid') %>% 
  group_by(measure) %>% 
  summarize(mean = mean(value))
```

## Plot results

```{r}
df.sudoku %>% 
  filter(measure != 'Loss') %>% 
  ggplot(aes(x = epoch, y = value)) +
  stat_summary(aes(fill = measure),
               fun.data = "mean_cl_boot",
               geom = "ribbon",
               alpha = .3) +
  stat_summary(aes(color = measure),
               fun = "mean",
               geom = "line") +
  facet_wrap(vars(dataset)) +
  labs(title = 'RRN - Sudoku 9x9', x = 'Epoch', y = 'Accuracy') +
  theme(legend.position = 'bottom') +
  guides(color = guide_legend(title="Measure"),
         fill = guide_legend(title="Measure")) +
  ggsave('../figures/rrn/rrn_sudoku.png', width = 8, height = 4.5)
```

# Hidden Single

## Load data

```{r, message=F}
df.hs.train = read_tsv("../data/rrn/rrn_hs_tr_results.tsv") %>% 
  mutate(run_id = factor(run_id),
         model = model %>% str_to_upper(),
         model = factor(model, levels = c('RRN', 'DRRN')),
         dataset = recode(dataset,
                          train = 'Train',
                          valid = 'Valid'),
         dataset = factor(dataset, levels = c('Train', 'Valid')),
         num_train = factor(num_train)) %>% 
  group_by(run_id, model, num_train, epoch, dataset) %>% 
  summarize(accuracy = mean(correct))

df.hs.test = read_tsv("../data/rrn/rrn_hs_te_results.tsv") %>% 
  mutate(run_id = factor(run_id),
         model = model %>% str_to_upper(),
         model = factor(model, levels = c('RRN', 'DRRN')),
         num_train = factor(num_train))
```

## Training plot

```{r}
df.hs.train %>%
  ggplot(aes(x = epoch,
             y = accuracy)) +
  stat_summary(aes(fill = num_train),
               fun.data = "mean_cl_boot",
               geom = "ribbon",
               alpha = 0.2) +
  stat_summary(aes(color = num_train),
               fun = "mean",
               geom = "line") +
  labs(title = 'RRN - Hidden Single Puzzles', x = 'Epoch', y = 'Accuracy') +
  guides(fill = guide_legend(title="Training Set Size"),
         color = guide_legend(title="Training Set Size")) +
  theme(legend.position = 'bottom') +
  facet_grid(cols = vars(dataset),
             rows = vars(model)) +
  ggsave('../figures/rrn/rrn_hs.png', width = 8, height = 4.5)
```

## Valid plot of DRRN with num_train == 500
```{r}
df.hs.train %>%
  filter(num_train == 500) %>% 
  ggplot(aes(x = epoch,
             y = accuracy,
             color = dataset)) +
  stat_summary(fun = "mean",
               geom = "line") +
  labs(title = 'DRRN Hidden Single Training',
       x = 'Epoch',
       y = 'Accuracy') +
  guides(fill = guide_legend(title="Training Set Size"),
         color = guide_legend(title="Training Set Size")) +
  theme(legend.position = 'bottom') +
  facet_wrap(vars(run_id)) +
  ggsave('../figures/rrn/drrn_train.png', width = 8, height = 4.5)
```

## Test plot

```{r}
df.hs.train %>% 
  filter(dataset == 'Valid',
         num_train == 500) %>% 
  group_by(run_id, model) %>% 
  filter(accuracy == max(accuracy)) %>% 
  filter(epoch == max(epoch)) %>% # must be on separate filter
  inner_join(df.hs.test,
             by = c('run_id', 'model', 'num_train', 'epoch')) %>% 
  pivot_longer(c(house_type, house_index, cell_index, digit_set),
               names_to='feature',
               values_to='condition') %>% 
  mutate(correct = as.numeric(correct),
         feature = recode_factor(feature,
                                 digit_set = 'Digit Set',
                                 house_index = 'House Index',
                                 cell_index = 'Cell Index',
                                 house_type = 'House Type',
                                 .ordered = TRUE),
         changed = ifelse(condition, 'Changed', 'Unchanged') %>% 
           factor(levels = c('Unchanged', 'Changed'))) %>%
  get_beta_hdci(correct,
                100000,
                c('model', 'feature', 'changed'),
                seed=0) %>% 
  ggplot(aes(x = feature, fill = changed)) +
  geom_bar(aes(y = mean),
           stat = 'identity',
           size = 1.5,
           position = position_dodge(.9)) +
  geom_linerange(aes(x = feature,
                     ymin = hdci_l,
                     ymax = hdci_h,
                     group = changed),
                 position = position_dodge2(.9)) +
  labs(title = 'RRN - Hidden Single Test',
       x = "Feature",
       y = "Accuracy") +
  guides(fill = guide_legend(title="Changed")) +
  facet_wrap(vars(model)) +
  theme(legend.position = 'bottom') +
  ggsave('../figures/rrn/rrn_hs_test.png', width = 8, height = 4.5)
```

