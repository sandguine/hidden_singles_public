---
title: "Test Phase"
author: "Andrew"
date: "11/12/2020"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 4
    theme: cosmo
    highlight: tango
    pandoc_args: ["--number-offset=2"]
---

This file is for comparing the analyses results between pilot (random effects)
and the final dataset. Since there are two ways to regress participants'
performances (fixed effects and random effects models), the final dataset
has two types of results.

```{r setup, include=FALSE}
# these options here change the formatting of how comments are rendered
knitr::opts_chunk$set(collapse = TRUE,
                      comment = "#>",
                      results = "hold",
                      fig.show = "hold")

# Clear any existing variables
rm(list = ls())
```

```{r libraries, message=FALSE}
library(tidyverse)
library(lme4)
library(broom)
library(glue)
library(brms)
```

# Initialization

## Helper Functions

```{r}
brm_diagnostics = function(brm_model) {
  s = brm_model %>% 
    summary()
  
  df = as_tibble(s[['fixed']], rownames = "term")
  return (df)
}

get_path = function(...) {
  path = list(...)
  dirname = plyr::splat(file.path)(path %>% head(-1))
  dir.create(dirname, recursive = T, showWarnings = F)
  filename = plyr::splat(file.path)(path)
  return (filename)
}

get_model_filename = function (analysis_name, df_subset, ht_subset, dv) {
  dirname = file.path('cache', analysis_name, df_subset, ht_subset)
  dir.create(dirname, recursive = T, showWarnings = F)
  filename = file.path(dirname, dv)
  return (filename)
}
```

## Data Wrangling
```{r}
df_subjects = read_tsv("../data/processed/subject_data.tsv")
solvers = df_subjects %>% 
  filter(solver) %>% 
  pull(subject_id)

df_puzzles = read_tsv(glue("../data/processed/puzzle_data.tsv")) %>% 
  filter(subject_id %in% solvers,
         phase == 2) %>% 
  mutate(subject_id = as.factor(subject_id),
         ltrial = log2(trial),
         lduration = log2(duration)) %>% 
  rename(ht = house_type,
         hi = house_index,
         ci = cell_index,
         ds = digit_set) %>% 
  arrange(subject_id, trial) %>% 
  select(subject_id, trial, ht, hi, ci, ds, correct, duration, ltrial, lduration)
```

## Regression Set-up

Computing Bayes Factor requires that the models are linked to the same DataFrame object, so can't create them ad hoc. Need to create them all beforehand.
```{r}
# Create a dataframe where all models will be stored 
df.bmodels = tibble()

df.acc = df_puzzles %>%
  mutate(correct = as.numeric(correct),
         gp = hi | ci)
df.acc.ht_t = df.acc %>% filter(ht)
df.acc.ht_f = df.acc %>% filter(!ht)
df.dur = df.acc %>% filter(correct == 1)
df.dur.ht_t = df.dur %>% filter(ht)
df.dur.ht_f = df.dur %>% filter(!ht)

df.acc2 = df.acc %>% filter(trial <= 16)
df.acc.ht_t2 = df.acc2 %>% filter(ht)
df.acc.ht_f2 = df.acc2 %>% filter(!ht)
df.dur2 = df.acc2 %>% filter(correct == 1)
df.dur.ht_t2 = df.dur2 %>% filter(ht)
df.dur.ht_f2 = df.dur2 %>% filter(!ht)

df.acc6 = df.acc %>%
  filter(trial > 16) %>% 
  mutate(trial = trial - 16,
         ltrial = log2(trial))
df.acc.ht_t6 = df.acc6 %>% filter(ht)
df.acc.ht_f6 = df.acc6 %>% filter(!ht)
df.dur6 = df.acc6 %>% filter(correct == 1)
df.dur.ht_t6 = df.dur6 %>% filter(ht)
df.dur.ht_f6 = df.dur6 %>% filter(!ht)
```

# House Type

## Main Analysis

```{r}
analysis_name = 'housetype_main'

bmodel.ht.acc = brm(correct ~ ht*ltrial + (ltrial | subject_id),
                    family = 'bernoulli',
                    data = df.acc,
                    save_all_pars = TRUE,
                    seed = 0,
                    cores = 4,
                    refresh = 0,
                    file = get_model_filename(analysis_name, 'allsets', 'ht_both', 'accuracy'))

bmodel.ht.dur = brm(lduration ~ ht*ltrial + (ltrial | subject_id),
                    data = df.dur,
                    save_all_pars = TRUE,
                    seed = 0,
                    cores = 4,
                    refresh = 0,
                    file = get_model_filename(analysis_name, 'allsets', 'ht_both', 'duration'))

bmodel.ht.acc2 = brm(correct ~ ht + ltrial + (ltrial | subject_id),
                     family = 'bernoulli',
                     data = df.acc2,
                     iter = 5000,
                     control = list(adapt_delta = 0.99),
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'first2sets', 'ht_both', 'accuracy'))

bmodel.ht.dur2 = brm(lduration ~ ht + ltrial + (ltrial | subject_id),
                     data = df.dur2,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'first2sets', 'ht_both', 'duration'))

bmodel.ht.acc6 = brm(correct ~ ht + ltrial + (ltrial | subject_id),
                     family = 'bernoulli',
                     data = df.acc6,
                     iter = 5000,
                     control = list(adapt_delta = 0.99),
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'last6sets', 'ht_both', 'accuracy'))

bmodel.ht.dur6 = brm(lduration ~ ht + ltrial + (ltrial | subject_id),
                     data = df.dur6,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'last6sets', 'ht_both', 'duration'))

df.bmodels = tibble(dv = c('accuracy', 'duration', 'accuracy', 'duration', 'accuracy', 'duration'),
                    model = analysis_name,
                    subset = c('allsets', 'allsets', 'first2sets', 'first2sets', 'last6sets', 'last6sets'),
                    ht_cond = 'both',
                    fit = list(bmodel.ht.acc, bmodel.ht.dur, bmodel.ht.acc2, bmodel.ht.dur2, bmodel.ht.acc6, bmodel.ht.dur6)) %>% 
  rbind(df.bmodels)
```

## Controlling for Starting House Type

```{r}
analysis_name = 'housetype_ht0'

df = df_subjects %>% 
  mutate(start_col = tut_house == 'column') %>% 
  select(subject_id, start_col)

bmodel.ht.ht0.acc = brm(correct ~ start_col*ht*ltrial + (ltrial | subject_id),
                        family = 'bernoulli',
                        data = df.acc %>% 
                          merge(df),
                        save_all_pars = TRUE,
                        seed = 0,
                        cores = 4,
                        refresh = 0,
                        file = get_model_filename(analysis_name, 'allsets', 'ht_both', 'accuracy'))

bmodel.ht.ht0.dur = brm(lduration ~ start_col*ht*ltrial + (ltrial | subject_id),
                        data = df.dur %>% 
                          merge(df),
                        save_all_pars = TRUE,
                        seed = 0,
                        cores = 4,
                        refresh = 0,
                        file = get_model_filename(analysis_name, 'allsets', 'ht_both', 'duration'))

bmodel.ht.ht0.acc2 = brm(correct ~ start_col*ht + ltrial + (ltrial | subject_id),
                         family = 'bernoulli',
                         data = df.acc2 %>% 
                          merge(df),
                         save_all_pars = TRUE,
                         seed = 0,
                         cores = 4,
                         refresh = 0,
                         file = get_model_filename(analysis_name, 'first2sets', 'ht_both', 'accuracy'))

bmodel.ht.ht0.dur2 = brm(lduration ~ start_col*ht + ltrial + (ltrial | subject_id),
                         data = df.dur2 %>% 
                          merge(df),
                         save_all_pars = TRUE,
                         seed = 0,
                         cores = 4,
                         refresh = 0,
                         file = get_model_filename(analysis_name, 'first2sets', 'ht_both', 'duration'))

bmodel.ht.ht0.acc6 = brm(correct ~ start_col*ht + ltrial + (ltrial | subject_id),
                         family = 'bernoulli',
                         data = df.acc6 %>% 
                          merge(df),
                         iter = 5000,
                         control = list(adapt_delta = 0.99),
                         save_all_pars = TRUE,
                         seed = 0,
                         cores = 4,
                         refresh = 0,
                         file = get_model_filename(analysis_name, 'last6sets', 'ht_both', 'accuracy'))

bmodel.ht.ht0.dur6 = brm(lduration ~ start_col*ht + ltrial + (ltrial | subject_id),
                         data = df.dur6 %>% 
                          merge(df),
                         save_all_pars = TRUE,
                         seed = 0,
                         cores = 4,
                         refresh = 0,
                         file = get_model_filename(analysis_name, 'last6sets', 'ht_both', 'duration'))

df.bmodels = tibble(dv = c('accuracy', 'duration', 'accuracy', 'duration', 'accuracy', 'duration'),
                    model = analysis_name,
                    subset = c('allsets', 'allsets', 'first2sets', 'first2sets', 'last6sets', 'last6sets'),
                    ht_cond = 'both',
                    fit = list(bmodel.ht.ht0.acc, bmodel.ht.ht0.dur, 
                               bmodel.ht.ht0.acc2, bmodel.ht.ht0.dur2, 
                               bmodel.ht.ht0.acc6, bmodel.ht.ht0.dur6)) %>% 
  rbind(df.bmodels)
```

# Change in position

## All collapsed

```{r}
analysis_name = 'position'

bmodel.gp.acc = brm(correct ~ gp*ltrial + (ltrial | subject_id),
                    family = 'bernoulli',
                    data = df.acc,
                    save_all_pars = TRUE,
                    seed = 0,
                    cores = 4,
                    refresh = 0,
                    file = get_model_filename(analysis_name, 'allsets', 'ht_both', 'accuracy'))

bmodel.gp.dur = brm(lduration ~ gp*ltrial + (ltrial | subject_id),
                    data = df.dur,
                    save_all_pars = TRUE,
                    seed = 0,
                    cores = 4,
                    refresh = 0,
                    file = get_model_filename(analysis_name, 'allsets', 'ht_both', 'duration'))

bmodel.gp.acc2 = brm(correct ~ gp + ltrial + (ltrial | subject_id),
                     family = 'bernoulli',
                     data = df.acc2,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'first2sets', 'ht_both', 'accuracy'))

bmodel.gp.dur2 = brm(lduration ~ gp + ltrial + (ltrial | subject_id),
                     data = df.dur2,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'first2sets', 'ht_both', 'duration'))

bmodel.gp.acc6 = brm(correct ~ gp + ltrial + (ltrial | subject_id),
                     family = 'bernoulli',
                     data = df.acc6,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'last6sets', 'ht_both', 'accuracy'))

bmodel.gp.dur6 = brm(lduration ~ gp + ltrial + (ltrial | subject_id),
                     data = df.dur6,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'last6sets', 'ht_both', 'duration'))

df.bmodels = tibble(dv = c('accuracy', 'duration', 'accuracy', 'duration', 'accuracy', 'duration'),
                    model = analysis_name,
                    subset = c('allsets', 'allsets', 'first2sets', 'first2sets', 'last6sets', 'last6sets'),
                    ht_cond = 'both',
                    fit = list(bmodel.gp.acc, bmodel.gp.dur, bmodel.gp.acc2, bmodel.gp.dur2, bmodel.gp.acc6, bmodel.gp.dur6)) %>% 
  rbind(df.bmodels)
```

## With HT unchanged

```{r}
analysis_name = 'position'
ht_subset = 'ht_false'

bmodel.pos.ht_f.acc = brm(correct ~ hi*ci*ltrial + (ltrial | subject_id),
                          family = 'bernoulli',
                          iter = 8000,
                          data = df.acc.ht_f,
                          save_all_pars = TRUE,
                          seed = 0,
                          cores = 4,
                          refresh = 0,
                          file = get_model_filename(analysis_name, 'allsets', ht_subset, 'accuracy'))

bmodel.pos.ht_f.dur = brm(lduration ~ hi*ci*ltrial + (ltrial | subject_id),
                          data = df.dur.ht_f,
                          save_all_pars = TRUE,
                          seed = 0,
                          cores = 4,
                          refresh = 0,
                          file = get_model_filename(analysis_name, 'allsets', ht_subset, 'duration'))

bmodel.pos.ht_f.acc2 = brm(correct ~ hi*ci + ltrial + (ltrial | subject_id),
                           family = 'bernoulli',
                           iter = 8000,
                           control = list(adapt_delta = 0.99),
                           data = df.acc.ht_f2,
                           save_all_pars = TRUE,
                           seed = 0,
                           cores = 4,
                           refresh = 0,
                           file = get_model_filename(analysis_name, 'first2sets', ht_subset, 'accuracy'))

bmodel.pos.ht_f.dur2 = brm(lduration ~ hi*ci + ltrial + (ltrial | subject_id),
                           data = df.dur.ht_f2,
                           save_all_pars = TRUE,
                           seed = 0,
                           cores = 4,
                           refresh = 0,
                           file = get_model_filename(analysis_name, 'first2sets', ht_subset, 'duration'))

bmodel.pos.ht_f.acc6 = brm(correct ~ hi*ci + ltrial + (ltrial | subject_id),
                           family = 'bernoulli',
                           data = df.acc.ht_f6,
                           save_all_pars = TRUE,
                           seed = 0,
                           cores = 4,
                           refresh = 0,
                           file = get_model_filename(analysis_name, 'last6sets', ht_subset, 'accuracy'))

bmodel.pos.ht_f.dur6 = brm(lduration ~ hi*ci + ltrial + (ltrial | subject_id),
                           data = df.dur.ht_f6,
                           save_all_pars = TRUE,
                           seed = 0,
                           cores = 4,
                           refresh = 0,
                           file = get_model_filename(analysis_name, 'last6sets', ht_subset, 'duration'))

df.bmodels = tibble(dv = c('accuracy', 'duration', 'accuracy', 'duration', 'accuracy', 'duration'),
                    model = analysis_name,
                    subset = c('allsets', 'allsets', 'first2sets', 'first2sets', 'last6sets', 'last6sets'),
                    ht_cond = ht_subset,
                    fit = list(bmodel.pos.ht_f.acc, bmodel.pos.ht_f.dur, bmodel.pos.ht_f.acc2,
                               bmodel.pos.ht_f.dur2, bmodel.pos.ht_f.acc6, bmodel.pos.ht_f.dur6)) %>% 
  rbind(df.bmodels)
```

## With HT changed

```{r}
analysis_name = 'position'
ht_subset = 'ht_true'

bmodel.pos.ht_t.acc = brm(correct ~ hi*ci*ltrial + (ltrial | subject_id),
                          family = 'bernoulli',
                          data = df.acc.ht_t,
                          save_all_pars = TRUE,
                          seed = 0,
                          cores = 4,
                          refresh = 0,
                          file = get_model_filename(analysis_name, 'allsets', ht_subset, 'accuracy'))

bmodel.pos.ht_t.dur = brm(lduration ~ hi*ci*ltrial + (ltrial | subject_id),
                          data = df.dur.ht_t,
                          save_all_pars = TRUE,
                          seed = 0,
                          cores = 4,
                          refresh = 0,
                          file = get_model_filename(analysis_name, 'allsets', ht_subset, 'duration'))

bmodel.pos.ht_t.acc2 = brm(correct ~ hi*ci + ltrial + (ltrial | subject_id),
                           family = 'bernoulli',
                           data = df.acc.ht_t2,
                           save_all_pars = TRUE,
                           seed = 0,
                           cores = 4,
                           refresh = 0,
                           file = get_model_filename(analysis_name, 'first2sets', ht_subset, 'accuracy'))

bmodel.pos.ht_t.dur2 = brm(lduration ~ hi*ci + ltrial + (ltrial | subject_id),
                           data = df.dur.ht_t2,
                           iter = 5000,
                           control = list(adapt_delta = 0.99),
                           save_all_pars = TRUE,
                           seed = 0,
                           cores = 4,
                           refresh = 0,
                           file = get_model_filename(analysis_name, 'first2sets', ht_subset, 'duration'))

bmodel.pos.ht_t.acc6 = brm(correct ~ hi*ci + ltrial + (ltrial | subject_id),
                           family = 'bernoulli',
                           iter = 8000,
                           data = df.acc.ht_t6,
                           save_all_pars = TRUE,
                           seed = 0,
                           cores = 4,
                           refresh = 0,
                           file = get_model_filename(analysis_name, 'last6sets', ht_subset, 'accuracy'))

bmodel.pos.ht_t.dur6 = brm(lduration ~ hi*ci + ltrial + (ltrial | subject_id),
                           data = df.dur.ht_t6,
                           save_all_pars = TRUE,
                           seed = 0,
                           cores = 4,
                           refresh = 0,
                           file = get_model_filename(analysis_name, 'last6sets', ht_subset, 'duration'))

df.bmodels = tibble(dv = c('accuracy', 'duration', 'accuracy', 'duration', 'accuracy', 'duration'),
                    model = analysis_name,
                    subset = c('allsets', 'allsets', 'first2sets', 'first2sets', 'last6sets', 'last6sets'),
                    ht_cond = ht_subset,
                    fit = list(bmodel.pos.ht_t.acc, bmodel.pos.ht_t.dur, bmodel.pos.ht_t.acc2,
                               bmodel.pos.ht_t.dur2, bmodel.pos.ht_t.acc6, bmodel.pos.ht_t.dur6)) %>% 
  rbind(df.bmodels)
```

# Change in Digit Set

## Regressions

```{r}
analysis_name = 'digitset'

bmodel.ds.acc = brm(correct ~ ds*ltrial + (ltrial | subject_id),
                    family = 'bernoulli',
                    data = df.acc,
                    save_all_pars = TRUE,
                    seed = 0,
                    cores = 4,
                    refresh = 0,
                    file = get_model_filename(analysis_name, 'allsets', 'ht_both', 'accuracy'))

bmodel.ds.dur = brm(lduration ~ ds*ltrial + (ltrial | subject_id),
                    data = df.dur,
                    save_all_pars = TRUE,
                    seed = 0,
                    cores = 4,
                    refresh = 0,
                    file = get_model_filename(analysis_name, 'allsets', 'ht_both', 'duration'))

bmodel.ds.acc2 = brm(correct ~ ds + ltrial + (ltrial | subject_id),
                     family = 'bernoulli',
                     data = df.acc2,
                     iter = 5000,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'first2sets', 'ht_both', 'accuracy'))

bmodel.ds.dur2 = brm(lduration ~ ds + ltrial + (ltrial | subject_id),
                     data = df.dur2,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'first2sets', 'ht_both', 'duration'))

bmodel.ds.acc6 = brm(correct ~ ds + ltrial + (ltrial | subject_id),
                     family = 'bernoulli',
                     data = df.acc6,
                     iter = 2000,
                     control = list(adapt_delta = 0.99),
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'last6sets', 'ht_both', 'accuracy'))

bmodel.ds.dur6 = brm(lduration ~ ds + ltrial + (ltrial | subject_id),
                     data = df.dur6,
                     save_all_pars = TRUE,
                     seed = 0,
                     cores = 4,
                     refresh = 0,
                     file = get_model_filename(analysis_name, 'last6sets', 'ht_both', 'duration'))

df.bmodels = tibble(dv = c('accuracy', 'duration', 'accuracy', 'duration', 'accuracy', 'duration'),
                    model = analysis_name,
                    subset = c('allsets', 'allsets', 'first2sets', 'first2sets', 'last6sets', 'last6sets'),
                    ht_cond = 'both',
                    fit = list(bmodel.ds.acc, bmodel.ds.dur, bmodel.ds.acc2, bmodel.ds.dur2, bmodel.ds.acc6, bmodel.ds.dur6)) %>% 
  rbind(df.bmodels)
```

# Save Results

Log coefficients

```{r}
df.coefficients = df.bmodels %>% 
  mutate(diagnostics = map(.x = fit, ~ brm_diagnostics(.x))) %>% 
  unnest(diagnostics) %>% 
  select(-fit)
df.coefficients %>% 
  write_tsv('../data/coefficients.tsv')
```